<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å››æµ·å¥½å®¶ä¼™ - ç­‰å¾…æˆ¿é—´</title>
    <script src="/js/websocket.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');

        :root {
            --primary-color: #4a148c;
            --secondary-color: #ff6f00;
            --accent-color: #ffab40;
            --text-color: #f5f5f5;
            --player-empty: #3a3a4a;
            --player-joined: #2ecc71;
            --player-ready: #3498db;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            font-family: 'ZCOOL KuaiLe', cursive;
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        h1 {
            font-size: 3rem;
            text-shadow: 0 0 10px var(--accent-color);
            margin-bottom: 1rem;
        }

        .room-info {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--accent-color);
        }

        .players-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 2rem;
            max-width: 800px;
            margin: 2rem auto;
        }

        .player-slot {
            position: relative;
            width: 120px;
            height: 160px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s;
        }

        .player-icon {
            width: 80px;
            height: 80px;
            background-color: var(--player-empty);
            border-radius: 50%;
            margin-bottom: 10px;
            transition: all 0.3s;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
            color: rgba(255, 255, 255, 0.2);
        }

        .player-icon::before {
            content: "ğŸ‘¤";
            position: absolute;
        }

        .player-icon.joined {
            background-color: var(--player-joined);
            box-shadow: 0 0 20px rgba(46, 204, 113, 0.5);
            color: white;
        }

        .player-icon.joined::before {
            content: "ğŸ˜";
            filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.5));
        }

        .player-icon.joined {
            background-color: var(--player-joined);
            box-shadow: 0 0 20px rgba(46, 204, 113, 0.5);
        }

        .player-label {
            font-size: 1.2rem;
            text-align: center;
        }

        .player-name {
            font-size: 1rem;
            color: var(--accent-color);
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .status-message {
            font-size: 1.5rem;
            margin-top: 2rem;
            text-align: center;
            min-height: 2rem;
            color: var(--accent-color);
        }

        .start-button {
            margin-top: 2rem;
            padding: 1rem 2rem;
            font-size: 1.5rem;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            opacity: 0;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .start-button.visible {
            opacity: 1;
        }

        .start-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        @media (max-width: 768px) {
            .players-container {
                gap: 1rem;
            }

            .player-slot {
                width: 80px;
                height: 120px;
            }

            .player-icon {
                width: 70px;
                height: 90px;
            }

            h1 {
                font-size: 2rem;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>

<body>
    <div class="header">
        <h1>ç­‰å¾…æˆ¿é—´</h1>
        <div class="room-info" id="roomInfo">
            æˆ¿é—´å·: åŠ è½½ä¸­...
        </div>
    </div>

    <div class="players-container" id="playersContainer">
        <!-- ç©å®¶æ§½ä½å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
    </div>

    <div class="status-message" id="statusMessage"></div>

    <button class="start-button" id="startButton">å¼€å§‹æ¸¸æˆ</button>

    <script>
        // ä»URLè·å–å‚æ•°
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room_id');
        const playerIdx = parseInt(urlParams.get('player_idx'));

        // å…¨å±€çŠ¶æ€
        let playerSlots = [];
        let maxPlayers = 4; // é»˜è®¤4äººï¼Œå®é™…ä»æœåŠ¡å™¨è·å–
        let isRoomOwner = false;

        // DOMå…ƒç´ 
        const roomInfoEl = document.getElementById('roomInfo');
        const playersContainerEl = document.getElementById('playersContainer');
        const statusMessageEl = document.getElementById('statusMessage');
        const startButtonEl = document.getElementById('startButton');

        // åˆå§‹åŒ–é¡µé¢
        function initPage() {
            // æ˜¾ç¤ºæˆ¿é—´ä¿¡æ¯
            roomInfoEl.textContent = `æˆ¿é—´å·: ${roomId} (ç©å®¶ ${playerIdx + 1})`;

            // æ£€æŸ¥æ˜¯å¦æ˜¯æˆ¿ä¸»ï¼ˆå‡è®¾ç¬¬ä¸€ä¸ªåŠ å…¥çš„æ˜¯æˆ¿ä¸»ï¼‰
            isRoomOwner = (playerIdx === 0);

            // ä»æœåŠ¡å™¨è·å–æˆ¿é—´ä¿¡æ¯ï¼ˆæ¨¡æ‹Ÿï¼‰
            fetchRoomInfo();

            // åˆå§‹åŒ–WebSocketè¿æ¥
            connectWebSocket(roomId, playerIdx);
        }

        // æ¨¡æ‹Ÿä»æœåŠ¡å™¨è·å–æˆ¿é—´ä¿¡æ¯
        function fetchRoomInfo() {
            // å®é™…åº”è¯¥é€šè¿‡WebSocketè¯·æ±‚æœåŠ¡å™¨
            setTimeout(() => {
                maxPlayers = 6; // å‡è®¾æœåŠ¡å™¨è¿”å›6äººæˆ¿é—´
                renderPlayerSlots();

                // æ¨¡æ‹Ÿå·²æœ‰ç©å®¶åŠ å…¥
                updatePlayerStatus(0, true, "ç©å®¶1");
                updatePlayerStatus(2, true, "ç©å®¶3");
                updatePlayerStatus(playerIdx, true, "ä½ ");
            }, 500);
        }

        // æ¸²æŸ“ç©å®¶æ§½ä½
        function renderPlayerSlots() {
            playersContainerEl.innerHTML = '';
            playerSlots = [];

            for (let i = 0; i < maxPlayers; i++) {
                const slot = document.createElement('div');
                slot.className = 'player-slot';
                slot.innerHTML = `
                    <div class="player-icon" id="playerIcon-${i}"></div>
                    <div class="player-label">
                        <div>ç©å®¶ ${i + 1}</div>
                        <div class="player-name" id="playerName-${i}">ç­‰å¾…åŠ å…¥...</div>
                    </div>
                `;
                playersContainerEl.appendChild(slot);
                playerSlots.push({
                    joined: false,
                    name: ''
                });
            }

            // å¦‚æœæ˜¯æˆ¿ä¸»ä¸”æˆ¿é—´å·²æ»¡ï¼Œæ˜¾ç¤ºå¼€å§‹æŒ‰é’®
            if (isRoomOwner && checkAllPlayersJoined()) {
                startButtonEl.classList.add('visible');
            }
        }

        // æ›´æ–°ç©å®¶çŠ¶æ€
        function updatePlayerStatus(index, joined, name = '') {
            const icon = document.getElementById(`playerIcon-${index}`);
            const nameEl = document.getElementById(`playerName-${index}`);

            if (icon) {
                if (joined) {
                    icon.classList.add('joined');
                    nameEl.textContent = name || `ç©å®¶ ${index + 1}`;
                    playerSlots[index].joined = true;
                    playerSlots[index].name = name;
                } else {
                    icon.classList.remove('joined');
                    nameEl.textContent = 'ç­‰å¾…åŠ å…¥...';
                    playerSlots[index].joined = false;
                    playerSlots[index].name = '';
                }
            }

            updateStatusMessage();

            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ç©å®¶éƒ½å·²åŠ å…¥
            if (isRoomOwner && checkAllPlayersJoined()) {
                startButtonEl.classList.add('visible');
            } else {
                startButtonEl.classList.remove('visible');
            }
        }

        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ç©å®¶éƒ½å·²åŠ å…¥
        function checkAllPlayersJoined() {
            return playerSlots.every(slot => slot.joined);
        }

        // æ›´æ–°çŠ¶æ€æ¶ˆæ¯
        function updateStatusMessage() {
            const joinedCount = playerSlots.filter(slot => slot.joined).length;

            if (joinedCount === maxPlayers) {
                statusMessageEl.textContent = 'æˆ¿é—´å·²æ»¡ï¼Œå‡†å¤‡å¼€å§‹æ¸¸æˆï¼';
            } else {
                statusMessageEl.textContent = `ç­‰å¾…ç©å®¶åŠ å…¥ (${joinedCount}/${maxPlayers})`;
            }
        }

        // å¼€å§‹æ¸¸æˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        startButtonEl.addEventListener('click', () => {
            // å‘é€å¼€å§‹æ¸¸æˆè¯·æ±‚åˆ°æœåŠ¡å™¨
            if (socket && socket.readyState === WebSocket.OPEN) {
                const request = {
                    action: "start_game",
                    room_id: roomId
                };
                socket.send(JSON.stringify(request));

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                statusMessageEl.textContent = 'æ¸¸æˆå³å°†å¼€å§‹...';
                startButtonEl.disabled = true;
            }
        });

        // WebSocketæ¶ˆæ¯å¤„ç†ï¼ˆè¦†ç›–websocket.jsä¸­çš„é»˜è®¤å¤„ç†ï¼‰
        function handleServerMessage(response) {
            console.log('ç­‰å¾…æˆ¿é—´æ”¶åˆ°æ¶ˆæ¯:', response);

            switch (response.action) {
                case 'player_joined':
                    updatePlayerStatus(response.player_idx, true, response.player_name);
                    break;

                case 'player_left':
                    updatePlayerStatus(response.player_idx, false);
                    break;

                case 'game_started':
                    // è·³è½¬åˆ°æ¸¸æˆé¡µé¢
                    window.location.href = `/game?room_id=${roomId}&player_idx=${playerIdx}`;
                    break;

                default:
                    console.log('æœªå¤„ç†çš„æ¶ˆæ¯ç±»å‹:', response.action);
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', initPage);
    </script>
</body>

</html>